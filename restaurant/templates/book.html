{% extends 'base.html' %}
{% load static %}

{% block content %}
<section>
  <article>
    <h1>Make a reservation</h1>
    
    <div id="message" class="message" style="display: none;"></div>
    
    <div class="opening-hours-info">
      <p id="opening-hours"><strong>Loading opening hours...</strong></p>
    </div>
    
    <!-- Booking form -->
    <form id="bookingForm">
      {% csrf_token %}
      <div id="form-container">
        <!-- Form will be loaded here -->
        <p>Loading form...</p>
      </div>
      <button type="submit" class="btn">Book</button>
    </form>
  </article>
  
  <article>
    <h2>Current Bookings</h2>
    <div id="date-selector">
      <label for="booking-date">Select Date:</label>
      <input type="date" id="booking-date" class="date-input">
    </div>
    
    <table class="booking-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody id="bookings-table-body">
        <tr>
          <td colspan="2">Loading bookings...</td>
        </tr>
      </tbody>
    </table>
  </article>
</section>

<script>
  // Get CSRF token for POST requests
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  const csrftoken = getCookie('csrftoken');
  let currentDate = new Date().toISOString().split('T')[0]; // Default to today
  
  // Show message function
  function showMessage(text, type = 'success') {
    const messageElement = document.getElementById('message');
    messageElement.textContent = text;
    messageElement.className = `message ${type}`;
    messageElement.style.display = 'block';
    
    // Hide message after 5 seconds
    setTimeout(() => {
      messageElement.style.display = 'none';
    }, 5000);
  }
  
  // Function to fetch booking form
  async function fetchBookingForm(date) {
    try {
      console.log('Fetching form for date:', date);
      const response = await fetch(`/book/?date=${date}&format=json`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('Form data:', data);
      
      // Update opening hours
      document.getElementById('opening-hours').innerHTML = 
        `<strong>Opening Hours for ${data.date_display}:</strong> ${data.hours_display}`;
      
      // Update form
      const formContainer = document.getElementById('form-container');
      formContainer.innerHTML = '';
      
      // Create first name field
      const nameField = document.createElement('div');
      nameField.className = 'form-field';
      nameField.innerHTML = `
        <label for="id_first_name">First Name:</label>
        <input type="text" id="id_first_name" name="first_name" required>
      `;
      formContainer.appendChild(nameField);
      
      // Create date field
      const dateField = document.createElement('div');
      dateField.className = 'form-field';
      dateField.innerHTML = `
        <label for="id_reservation_date">Reservation Date:</label>
        <input type="date" id="id_reservation_date" name="reservation_date" value="${date}" required>
      `;
      formContainer.appendChild(dateField);
      
      // Create time slot dropdown
      const slotField = document.createElement('div');
      slotField.className = 'form-field';
      
      // Check if we have available slots
      if (data.available_slots && data.available_slots.length > 0) {
        let slotOptions = '<option value="">Select a time</option>';
        data.available_slots.forEach(slot => {
          slotOptions += `<option value="${slot[0]}">${slot[1]}</option>`;
        });
        
        slotField.innerHTML = `
          <label for="id_reservation_slot">Reservation Time:</label>
          <select id="id_reservation_slot" name="reservation_slot" required>
            ${slotOptions}
          </select>
        `;
      } else {
        slotField.innerHTML = `
          <label for="id_reservation_slot">Reservation Time:</label>
          <div class="no-slots-message">No available time slots for this date. Please select another date.</div>
        `;
      }
      
      formContainer.appendChild(slotField);
      
      // Set up date change event
      document.getElementById('id_reservation_date').addEventListener('change', function() {
        currentDate = this.value;
        fetchBookingForm(currentDate);
        fetchBookings(currentDate);
      });
      
      // Set submit button state based on available slots
      const submitButton = document.querySelector('#bookingForm button[type="submit"]');
      if (data.available_slots && data.available_slots.length > 0) {
        submitButton.disabled = false;
      } else {
        submitButton.disabled = true;
      }
      
    } catch (error) {
      console.error('Error fetching form:', error);
      document.getElementById('form-container').innerHTML = 
        '<p class="error">Error loading booking form. Please try again later.</p>';
      
      showMessage('Error loading booking form. Please try again.', 'error');
    }
  }
  
  // Function to fetch bookings for a date
  async function fetchBookings(date) {
    try {
      console.log('Fetching bookings for date:', date);
      const response = await fetch(`/bookings/?date=${date}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('Bookings data:', data);
      
      const tableBody = document.getElementById('bookings-table-body');
      
      // Clear existing rows
      tableBody.innerHTML = '';
      
      // Check if we have bookings
      if (data.bookings && data.bookings.length > 0) {
        // Add a row for each booking
        data.bookings.forEach(booking => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${booking.fields.first_name}</td>
            <td>${booking.fields.reservation_slot}:00</td>
          `;
          tableBody.appendChild(row);
        });
      } else {
        // Show no bookings message
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="2">No reservations for this date.</td>';
        tableBody.appendChild(row);
      }
    } catch (error) {
      console.error('Error fetching bookings:', error);
      document.getElementById('bookings-table-body').innerHTML = 
        '<tr><td colspan="2">Error loading bookings. Please try again.</td></tr>';
      
      showMessage('Error loading bookings. Please try again.', 'error');
    }
  }
  
  // Submit booking form
  document.getElementById('bookingForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Disable submit button to prevent multiple submissions
    const submitButton = this.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.textContent = 'Booking...';
    
    const formData = new FormData();
    formData.append('first_name', document.getElementById('id_first_name').value);
    formData.append('reservation_date', document.getElementById('id_reservation_date').value);
    formData.append('reservation_slot', document.getElementById('id_reservation_slot').value);
    
    try {
      const response = await fetch('/book/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      });
      
      // Re-enable submit button
      submitButton.disabled = false;
      submitButton.textContent = 'Book';
      
      if (response.ok) {
        const result = await response.json();
        console.log('Booking result:', result);
        
        if (result.status === 'success') {
          // Show success message
          showMessage('Booking successful!', 'success');
          
          // Reset form fields
          document.getElementById('id_first_name').value = '';
          
          // Get the currently selected date (it might have changed during form submission)
          const reservationDate = document.getElementById('id_reservation_date').value;
          
          // Refresh form to update available slots
          fetchBookingForm(reservationDate);
          
          // Refresh bookings list
          fetchBookings(reservationDate);
        } else {
          showMessage(`Booking failed: ${result.message || 'Unknown error'}`, 'error');
        }
      } else {
        const error = await response.json();
        console.error('Booking error:', error);
        
        let errorMessage = 'Booking failed: ';
        if (error.errors) {
          // Format error messages
          const errorList = [];
          for (const field in error.errors) {
            errorList.push(`${field}: ${error.errors[field].join(', ')}`);
          }
          errorMessage += errorList.join('; ');
        } else if (error.message) {
          errorMessage += error.message;
        } else {
          errorMessage += 'Unknown error';
        }
        
        showMessage(errorMessage, 'error');
      }
    } catch (error) {
      console.error('Error submitting form:', error);
      submitButton.disabled = false;
      submitButton.textContent = 'Book';
      
      showMessage('Error submitting booking. Please try again.', 'error');
    }
  });
  
  // Initialize date selector
  document.getElementById('booking-date').value = currentDate;
  document.getElementById('booking-date').addEventListener('change', function() {
    currentDate = this.value;
    fetchBookingForm(currentDate);
    fetchBookings(currentDate);
  });
  
  // Check URL for date parameter
  function getUrlParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }
  
  // Load initial data
  document.addEventListener('DOMContentLoaded', () => {
    // Check if there's a date parameter in the URL
    const dateParam = getUrlParam('date');
    if (dateParam) {
      currentDate = dateParam;
      document.getElementById('booking-date').value = currentDate;
    }
    
    fetchBookingForm(currentDate);
    fetchBookings(currentDate);
  });
</script>

<style>
  .message {
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
    text-align: center;
    display: none;
  }
  
  .message.success {
    background-color: #d4edda;
    border-left: 5px solid #28a745;
    color: #155724;
  }
  
  .message.error {
    background-color: #f8d7da;
    border-left: 5px solid #dc3545;
    color: #721c24;
  }
  
  .opening-hours-info {
    background-color: #f8f9fa;
    padding: 10px 15px;
    border-radius: 4px;
    margin-bottom: 20px;
    border-left: 4px solid #495E57;
  }
  
  .form-field {
    margin-bottom: 15px;
  }
  
  .form-field label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }
  
  .form-field input, .form-field select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
  }
  
  .no-slots-message {
    padding: 10px;
    background-color: #fff3cd;
    border-left: 4px solid #ffc107;
    color: #856404;
    border-radius: 4px;
  }
  
  #date-selector {
    margin-bottom: 15px;
  }
  
  .date-input {
    padding: 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
  }
  
  .booking-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  
  .booking-table th, .booking-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }
  
  .booking-table th {
    background-color: #495E57;
    color: white;
  }
  
  .booking-table tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  
  .btn {
    background-color: #495E57;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 10px;
  }
  
  .btn:hover {
    background-color: #45a049;
  }
  
  .btn:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }
  
  .error {
    color: #dc3545;
    padding: 10px;
    background-color: #f8d7da;
    border-radius: 4px;
  }
</style>
{% endblock %}